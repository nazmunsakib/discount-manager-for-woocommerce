/**
 * Fixed React Admin App
 */
(function() {
    'use strict';
    
    console.log('DMWOO: Script loading...');
    
    // Wait for WordPress to be ready
    function waitForWP(callback) {
        if (typeof wp !== 'undefined' && wp.element && wp.components && wp.i18n && wp.apiFetch) {
            console.log('DMWOO: WordPress React ready');
            callback();
        } else {
            console.log('DMWOO: Waiting for WordPress React...');
            setTimeout(() => waitForWP(callback), 100);
        }
    }
    
    function initApp() {
        const { createElement: e, useState, useEffect } = wp.element;
        const { Button, Card, CardBody, TextControl, SelectControl, Notice } = wp.components;
        const { __ } = wp.i18n;
        
        // Simple Rules List
        const RulesList = ({ rules, onEdit, onDelete, onAdd, onToggleStatus }) => {
            return e('div', { className: 'dmwoo-rules-container' },
                e('div', { className: 'dmwoo-header' },
                    e('h2', null, __('Discount Rules', 'discount-manager-woocommerce')),
                    e(Button, {
                        variant: 'primary',
                        onClick: onAdd
                    }, __('Add New Rule', 'discount-manager-woocommerce'))
                ),
                
                rules.length === 0 ? 
                    e('div', { className: 'dmwoo-empty' },
                        e('p', null, __('No discount rules found.', 'discount-manager-woocommerce')),
                        e('p', null, __('Create your first rule to get started!', 'discount-manager-woocommerce'))
                    ) :
                    e('div', { className: 'dmwoo-rules-grid' },
                        rules.map(rule => 
                            e(Card, { key: rule.id, className: 'dmwoo-rule-card' },
                                e(CardBody, null,
                                    e('div', { className: 'dmwoo-rule-header' },
                                        e('h3', null, rule.title),
                                        e('span', { 
                                            className: `dmwoo-status dmwoo-status-${rule.status}`,\n                                            onClick: () => onToggleStatus(rule)\n                                        }, rule.status)\n                                    ),\n                                    e('p', null, \n                                        rule.discount_type === 'percentage' ? \n                                            `${rule.discount_value}% discount` :\n                                            `Bulk discount (${rule.conditions?.bulk_ranges?.length || 0} ranges)`\n                                    ),\n                                    rule.description && e('p', { className: 'dmwoo-description' }, rule.description),\n                                    e('div', { className: 'dmwoo-rule-actions' },\n                                        e(Button, {\n                                            variant: 'secondary',\n                                            size: 'small',\n                                            onClick: () => onEdit(rule)\n                                        }, __('Edit', 'discount-manager-woocommerce')),\n                                        e(Button, {\n                                            variant: 'link',\n                                            isDestructive: true,\n                                            size: 'small',\n                                            onClick: () => onDelete(rule.id)\n                                        }, __('Delete', 'discount-manager-woocommerce'))\n                                    )\n                                )\n                            )\n                        )\n                    )\n            );\n        };\n        \n        // Rule Form\n        const RuleForm = ({ rule, onSave, onCancel }) => {\n            const [title, setTitle] = useState(rule?.title || '');\n            const [description, setDescription] = useState(rule?.description || '');\n            const [discountType, setDiscountType] = useState(rule?.discount_type || 'percentage');\n            const [discountValue, setDiscountValue] = useState(rule?.discount_value || 10);\n            const [minSubtotal, setMinSubtotal] = useState(rule?.conditions?.min_subtotal || '');\n            const [minQuantity, setMinQuantity] = useState(rule?.conditions?.min_quantity || '');\n            const [dateFrom, setDateFrom] = useState(rule?.date_from || '');\n            const [dateTo, setDateTo] = useState(rule?.date_to || '');\n            const [usageLimit, setUsageLimit] = useState(rule?.usage_limit || '');\n            const [priority, setPriority] = useState(rule?.priority || 10);\n            const [status, setStatus] = useState(rule?.status || 'active');\n            \n            const [bulkRanges, setBulkRanges] = useState(\n                rule?.conditions?.bulk_ranges || [{ min: 1, max: '', discount: 10 }]\n            );\n            \n            const handleSave = () => {\n                if (!title.trim()) {\n                    alert(__('Please enter a rule title', 'discount-manager-woocommerce'));\n                    return;\n                }\n                \n                const data = {\n                    title: title.trim(),\n                    description: description.trim(),\n                    discount_type: discountType,\n                    discount_value: discountValue,\n                    conditions: {\n                        min_subtotal: minSubtotal ? parseFloat(minSubtotal) : null,\n                        min_quantity: minQuantity ? parseInt(minQuantity) : null,\n                        bulk_ranges: discountType === 'bulk' ? bulkRanges : null\n                    },\n                    date_from: dateFrom || null,\n                    date_to: dateTo || null,\n                    usage_limit: usageLimit ? parseInt(usageLimit) : null,\n                    priority: priority,\n                    status: status\n                };\n                \n                onSave(data);\n            };\n            \n            const addBulkRange = () => {\n                setBulkRanges([...bulkRanges, { min: '', max: '', discount: 0 }]);\n            };\n            \n            const updateBulkRange = (index, field, value) => {\n                const newRanges = [...bulkRanges];\n                newRanges[index][field] = value;\n                setBulkRanges(newRanges);\n            };\n            \n            const removeBulkRange = (index) => {\n                if (bulkRanges.length > 1) {\n                    setBulkRanges(bulkRanges.filter((_, i) => i !== index));\n                }\n            };\n            \n            return e('div', { className: 'dmwoo-form-container' },\n                e('h2', null, rule ? __('Edit Rule', 'discount-manager-woocommerce') : __('Add New Rule', 'discount-manager-woocommerce')),\n                \n                // Basic Info\n                e('div', { className: 'dmwoo-form-section' },\n                    e('h3', null, __('Basic Information', 'discount-manager-woocommerce')),\n                    e(TextControl, {\n                        label: __('Rule Title', 'discount-manager-woocommerce'),\n                        value: title,\n                        onChange: setTitle,\n                        placeholder: __('e.g., Summer Sale 20% Off', 'discount-manager-woocommerce')\n                    }),\n                    e(TextControl, {\n                        label: __('Description (Optional)', 'discount-manager-woocommerce'),\n                        value: description,\n                        onChange: setDescription,\n                        placeholder: __('Brief description of this discount rule', 'discount-manager-woocommerce')\n                    }),\n                    e(SelectControl, {\n                        label: __('Status', 'discount-manager-woocommerce'),\n                        value: status,\n                        options: [\n                            { label: __('Active', 'discount-manager-woocommerce'), value: 'active' },\n                            { label: __('Inactive', 'discount-manager-woocommerce'), value: 'inactive' }\n                        ],\n                        onChange: setStatus\n                    })\n                ),\n                \n                // Discount Config\n                e('div', { className: 'dmwoo-form-section' },\n                    e('h3', null, __('Discount Configuration', 'discount-manager-woocommerce')),\n                    e(SelectControl, {\n                        label: __('Discount Type', 'discount-manager-woocommerce'),\n                        value: discountType,\n                        options: [\n                            { label: __('Percentage Discount', 'discount-manager-woocommerce'), value: 'percentage' },\n                            { label: __('Bulk Discount', 'discount-manager-woocommerce'), value: 'bulk' }\n                        ],\n                        onChange: setDiscountType\n                    }),\n                    \n                    discountType === 'percentage' && e(TextControl, {\n                        label: __('Discount Percentage', 'discount-manager-woocommerce'),\n                        type: 'number',\n                        value: discountValue,\n                        onChange: (value) => setDiscountValue(parseFloat(value) || 0),\n                        min: 0,\n                        max: 100,\n                        step: 0.01\n                    }),\n                    \n                    discountType === 'bulk' && e('div', { className: 'dmwoo-bulk-section' },\n                        e('h4', null, __('Bulk Discount Ranges', 'discount-manager-woocommerce')),\n                        bulkRanges.map((range, index) => \n                            e('div', { key: index, className: 'dmwoo-bulk-range' },\n                                e(TextControl, {\n                                    label: __('Min Qty', 'discount-manager-woocommerce'),\n                                    type: 'number',\n                                    value: range.min,\n                                    onChange: (value) => updateBulkRange(index, 'min', parseInt(value) || 0)\n                                }),\n                                e(TextControl, {\n                                    label: __('Max Qty', 'discount-manager-woocommerce'),\n                                    type: 'number',\n                                    value: range.max,\n                                    onChange: (value) => updateBulkRange(index, 'max', value ? parseInt(value) : ''),\n                                    placeholder: __('Unlimited', 'discount-manager-woocommerce')\n                                }),\n                                e(TextControl, {\n                                    label: __('Discount %', 'discount-manager-woocommerce'),\n                                    type: 'number',\n                                    value: range.discount,\n                                    onChange: (value) => updateBulkRange(index, 'discount', parseFloat(value) || 0),\n                                    min: 0,\n                                    max: 100\n                                }),\n                                bulkRanges.length > 1 && e(Button, {\n                                    variant: 'link',\n                                    isDestructive: true,\n                                    onClick: () => removeBulkRange(index)\n                                }, __('Remove', 'discount-manager-woocommerce'))\n                            )\n                        ),\n                        e(Button, {\n                            variant: 'secondary',\n                            onClick: addBulkRange\n                        }, __('Add Range', 'discount-manager-woocommerce'))\n                    )\n                ),\n                \n                // Conditions\n                e('div', { className: 'dmwoo-form-section' },\n                    e('h3', null, __('Conditions (Optional)', 'discount-manager-woocommerce')),\n                    e('div', { className: 'dmwoo-conditions-grid' },\n                        e(TextControl, {\n                            label: __('Minimum Cart Subtotal', 'discount-manager-woocommerce'),\n                            type: 'number',\n                            value: minSubtotal,\n                            onChange: setMinSubtotal,\n                            placeholder: __('No minimum', 'discount-manager-woocommerce')\n                        }),\n                        e(TextControl, {\n                            label: __('Minimum Quantity', 'discount-manager-woocommerce'),\n                            type: 'number',\n                            value: minQuantity,\n                            onChange: setMinQuantity,\n                            placeholder: __('No minimum', 'discount-manager-woocommerce')\n                        })\n                    )\n                ),\n                \n                // Advanced\n                e('div', { className: 'dmwoo-form-section' },\n                    e('h3', null, __('Advanced Settings', 'discount-manager-woocommerce')),\n                    e('div', { className: 'dmwoo-advanced-grid' },\n                        e(TextControl, {\n                            label: __('Usage Limit', 'discount-manager-woocommerce'),\n                            type: 'number',\n                            value: usageLimit,\n                            onChange: setUsageLimit,\n                            placeholder: __('Unlimited', 'discount-manager-woocommerce')\n                        }),\n                        e(TextControl, {\n                            label: __('Priority', 'discount-manager-woocommerce'),\n                            type: 'number',\n                            value: priority,\n                            onChange: (value) => setPriority(parseInt(value) || 10),\n                            help: __('Lower numbers = higher priority', 'discount-manager-woocommerce')\n                        })\n                    ),\n                    e('div', { className: 'dmwoo-date-grid' },\n                        e('div', null,\n                            e('label', null, __('Start Date (Optional)', 'discount-manager-woocommerce')),\n                            e('input', {\n                                type: 'datetime-local',\n                                value: dateFrom,\n                                onChange: (e) => setDateFrom(e.target.value)\n                            })\n                        ),\n                        e('div', null,\n                            e('label', null, __('End Date (Optional)', 'discount-manager-woocommerce')),\n                            e('input', {\n                                type: 'datetime-local',\n                                value: dateTo,\n                                onChange: (e) => setDateTo(e.target.value)\n                            })\n                        )\n                    )\n                ),\n                \n                // Actions\n                e('div', { className: 'dmwoo-form-actions' },\n                    e(Button, {\n                        variant: 'primary',\n                        onClick: handleSave\n                    }, rule ? __('Update Rule', 'discount-manager-woocommerce') : __('Create Rule', 'discount-manager-woocommerce')),\n                    e(Button, {\n                        variant: 'secondary',\n                        onClick: onCancel\n                    }, __('Cancel', 'discount-manager-woocommerce'))\n                )\n            );\n        };\n        \n        // Main App\n        const App = () => {\n            const [rules, setRules] = useState([]);\n            const [loading, setLoading] = useState(true);\n            const [editingRule, setEditingRule] = useState(null);\n            const [showForm, setShowForm] = useState(false);\n            const [notice, setNotice] = useState(null);\n            \n            useEffect(() => {\n                loadRules();\n            }, []);\n            \n            const loadRules = async () => {\n                try {\n                    console.log('DMWOO: Loading rules...');\n                    const response = await wp.apiFetch({ path: '/dmwoo/v1/rules' });\n                    console.log('DMWOO: Rules loaded:', response);\n                    setRules(response || []);\n                } catch (error) {\n                    console.error('DMWOO: Error loading rules:', error);\n                    setNotice({ type: 'error', message: __('Failed to load rules', 'discount-manager-woocommerce') });\n                } finally {\n                    setLoading(false);\n                }\n            };\n            \n            const handleSaveRule = async (ruleData) => {\n                try {\n                    console.log('DMWOO: Saving rule:', ruleData);\n                    if (editingRule) {\n                        await wp.apiFetch({\n                            path: `/dmwoo/v1/rules/${editingRule.id}`,\n                            method: 'PUT',\n                            data: ruleData\n                        });\n                        setNotice({ type: 'success', message: __('Rule updated successfully', 'discount-manager-woocommerce') });\n                    } else {\n                        await wp.apiFetch({\n                            path: '/dmwoo/v1/rules',\n                            method: 'POST',\n                            data: ruleData\n                        });\n                        setNotice({ type: 'success', message: __('Rule created successfully', 'discount-manager-woocommerce') });\n                    }\n                    loadRules();\n                    setShowForm(false);\n                    setEditingRule(null);\n                } catch (error) {\n                    console.error('DMWOO: Error saving rule:', error);\n                    setNotice({ type: 'error', message: __('Failed to save rule', 'discount-manager-woocommerce') });\n                }\n            };\n            \n            const handleDeleteRule = async (ruleId) => {\n                if (!confirm(__('Are you sure you want to delete this rule?', 'discount-manager-woocommerce'))) {\n                    return;\n                }\n                \n                try {\n                    await wp.apiFetch({\n                        path: `/dmwoo/v1/rules/${ruleId}`,\n                        method: 'DELETE'\n                    });\n                    setNotice({ type: 'success', message: __('Rule deleted successfully', 'discount-manager-woocommerce') });\n                    loadRules();\n                } catch (error) {\n                    console.error('DMWOO: Error deleting rule:', error);\n                    setNotice({ type: 'error', message: __('Failed to delete rule', 'discount-manager-woocommerce') });\n                }\n            };\n            \n            const handleToggleStatus = async (rule) => {\n                const newStatus = rule.status === 'active' ? 'inactive' : 'active';\n                try {\n                    await wp.apiFetch({\n                        path: `/dmwoo/v1/rules/${rule.id}`,\n                        method: 'PUT',\n                        data: { ...rule, status: newStatus }\n                    });\n                    loadRules();\n                } catch (error) {\n                    console.error('DMWOO: Error toggling status:', error);\n                    setNotice({ type: 'error', message: __('Failed to update rule status', 'discount-manager-woocommerce') });\n                }\n            };\n            \n            if (loading) {\n                return e('div', { className: 'dmwoo-loading' }, \n                    __('Loading discount rules...', 'discount-manager-woocommerce')\n                );\n            }\n            \n            return e('div', { className: 'dmwoo-app' },\n                notice && e(Notice, {\n                    status: notice.type,\n                    onRemove: () => setNotice(null),\n                    isDismissible: true\n                }, notice.message),\n                \n                showForm ? \n                    e(RuleForm, {\n                        rule: editingRule,\n                        onSave: handleSaveRule,\n                        onCancel: () => {\n                            setShowForm(false);\n                            setEditingRule(null);\n                        }\n                    }) :\n                    e(RulesList, {\n                        rules: rules,\n                        onEdit: (rule) => {\n                            setEditingRule(rule);\n                            setShowForm(true);\n                        },\n                        onDelete: handleDeleteRule,\n                        onAdd: () => {\n                            setEditingRule(null);\n                            setShowForm(true);\n                        },\n                        onToggleStatus: handleToggleStatus\n                    })\n            );\n        };\n        \n        // Render the app\n        const container = document.getElementById('dmwoo-admin-root');\n        if (container) {\n            console.log('DMWOO: Rendering React app...');\n            wp.element.render(e(App), container);\n            console.log('DMWOO: React app rendered successfully');\n        } else {\n            console.error('DMWOO: Container not found');\n        }\n    }\n    \n    // Initialize when ready\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', () => waitForWP(initApp));\n    } else {\n        waitForWP(initApp);\n    }\n})();